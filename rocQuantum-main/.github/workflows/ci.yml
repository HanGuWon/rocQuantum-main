name: rocQuantum CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ---------------------------------------------------------------
  # Python validation: syntax, imports, unit tests
  # ---------------------------------------------------------------
  python-tests:
    name: Python Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12", "3.13"]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy scipy

      - name: Syntax check (all Python files)
        run: |
          python -c "
          import ast, pathlib, sys
          errors = []
          for p in pathlib.Path('.').rglob('*.py'):
              if 'build' in p.parts or '.git' in p.parts:
                  continue
              try:
                  ast.parse(p.read_text(encoding='utf-8'), filename=str(p))
              except SyntaxError as e:
                  errors.append(f'{p}: {e}')
          if errors:
              print('Syntax errors found:')
              for e in errors:
                  print(f'  {e}')
              sys.exit(1)
          print(f'All Python files parse cleanly.')
          "

      - name: Run P0/P0.1 tests
        run: python -m unittest tests.test_p0_fixes -v

      - name: Run P1 compiler tests
        run: python -m unittest tests.test_p1_compiler -v

      - name: Run P2 packaging tests
        run: python -m unittest tests.test_p2_packaging -v

      - name: Run integration tests
        run: |
          python -m unittest tests.test_cirq_integration -v
          python -m unittest tests.test_pennylane_integration -v

  # ---------------------------------------------------------------
  # ROCm 6.2 build (required)
  # ---------------------------------------------------------------
  rocm-build:
    name: ROCm 6.2 Build
    runs-on: ubuntu-latest
    container:
      image: rocm/dev-ubuntu-22.04:6.2
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build

      - name: Configure
        run: cmake -S . -B build-ci -G Ninja -DCMAKE_CXX_COMPILER=hipcc

      - name: Build
        run: cmake --build build-ci --parallel

  # ---------------------------------------------------------------
  # ROCm 7.2 signal lane (optional, does not block merge)
  # ---------------------------------------------------------------
  rocm-build-next:
    name: ROCm 7.2 Build (signal)
    runs-on: ubuntu-latest
    continue-on-error: true
    container:
      image: rocm/dev-ubuntu-22.04:7.2
    steps:
      - uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          apt-get update
          apt-get install -y cmake ninja-build

      - name: Configure
        run: cmake -S . -B build-ci -G Ninja -DCMAKE_CXX_COMPILER=hipcc

      - name: Build
        run: cmake --build build-ci --parallel
